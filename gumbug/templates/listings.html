{% extends '_base.html' %}

{% block title %}{{ search.name }} | Gumbug Search{% endblock %}

{% block headerjs %}

{% csrf_token %}

<script>
	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie != '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

	function initialize() {
		
		function csrfSafeMethod(method) {
		    // these HTTP methods do not require CSRF protection
		    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		$.ajaxSetup({
		    beforeSend: function(xhr, settings) {
		        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
		            xhr.setRequestHeader("X-CSRFToken", csrftoken);
		        }
		    }
		});
		
		$(".btn-ignore").click(function(e) {
			e.preventDefault();
			var dataId = $(this).attr("data-id");
			var div = $(this).closest("div.search-listing");
			console.log("Div: " + div);
			div.addClass("ignored");
			$(this).hide();

			$.post("/s/{{ search.slug }}/ignore/" + dataId, {ignore: "true"}, function(data) {
				console.log("Ad " + dataId+ " ignored.");
			});
			
		});

		$(".btn-unignore").click(function(e) {
			e.preventDefault();
			var dataId = $(this).attr("data-id");
			var div = $(this).closest("div.search-listing");
			console.log("Div: " + div);
			div.removeClass("ignored");
			$(this).hide();

			$.post("/s/{{ search.slug }}/ignore/" + dataId, {ignore: "false"}, function(data) {
				console.log("Ad " + dataId+ " unignored.");
			});
			
		});

		$(".btn-favorite").click(function(e) {
			e.preventDefault();
			var dataId = $(this).attr("data-id");
			var div = $(this).closest("div.search-listing");
			console.log("Div: " + div);
			div.addClass("favorite");
			$(this).hide();

			$.post("/s/{{ search.slug }}/favorite/" + dataId, {favorite: "true"}, function(data) {
				console.log("Ad " + dataId+ " favorited.");
			});
			
		});

		$(".btn-unfavorite").click(function(e) {
			e.preventDefault();
			var dataId = $(this).attr("data-id");
			var div = $(this).closest("div.search-listing");
			console.log("Div: " + div);
			div.removeClass("favorite");
			$(this).hide();

			$.post("/s/{{ search.slug }}/favorite/" + dataId, {favorite: "false"}, function(data) {
				console.log("Ad " + dataId+ " unfavorited.");
			});
			
		});

		var map_canvas, mapOptions, map, loc;

{% for listing in listings %}
	{% if listing.lat and listing.lon %}

		loc = new google.maps.LatLng({{ listing.lat }}, {{ listing.lon }});
		map_canvas = document.getElementById('map_canvas_{{ listing.id }}');
		mapOptions = {
			center: loc,
			zoom: 15,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		map = new google.maps.Map(map_canvas, mapOptions);
		new google.maps.Marker({position: loc, map: map,});

	{% endif %}
{% endfor %}
	}
	google.maps.event.addDomListener(window, 'load', initialize);
</script>

{% endblock %}

{% block body %}

{% include "_previous_searches.html" %}

<div class="row">
	<h1>[{{ search.modified|date:"SHORT_DATETIME_FORMAT" }}] - Gumbug search</h1>
</div>

Showing results from:
<ul>
{% for search_url in search.searchurl_set.all %}
	<li><a href="{{ search_url.url }}" target="_blank">{{ search_url.url }}</a></li>
{% endfor %}
</ul>

<p>Ignoring keywords: <strong>{{ search.ignore_keywords }}</strong></p>

<p>Requiring keywords: <strong>{{ search.require_keywords }}</strong></p>

<form action="{% url 'listings' search.slug %}" method="POST" style="display: inline;">
{% csrf_token %}
<input type="submit" class="btn btn-primary" value="Redo search with same parameters"><br>
</form>
(Redoing the search will automatically continue to ignore the items that you added to your ignore list)

<div class="row"><h4>{{ valid_count }} valid listings, {{ ignored_count }} ignored</h4></div>

{% include "_pagination.html" %}

<div class="listings">
	{% for listing in listings %}
		{% include "_listing.html" %}
	{% endfor %}
</div>

{% include "_pagination.html" %}

{% endblock %}
